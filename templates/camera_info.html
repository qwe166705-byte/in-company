<!DOCTYPE html>
<html class="x-admin-sm">
<head>
    <meta charset="UTF-8">
    <title>欢迎页面-IPC</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi"/>
    <link rel="stylesheet" href="../static/css/font.css">
    <link rel="stylesheet" href="../static/css/xadmin.css">
    <script src="../static/lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../static/js/xadmin.js"></script>
    <script type="text/javascript" src="../static/js/jquery.min.js"></script>
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        /* 确保下拉菜单可见 */
        .layui-form input[type=checkbox], .layui-form input[type=radio], .layui-form select {
            display: block;
        }

    </style>
</head>
<body>
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-body ">
                    <form class="layui-form layui-col-space5" action="/camera_info" method="get">
                        <div class="layui-inline layui-show-xs-block">
                            <select name="machine_pm" id="machine_pm" class="layui-input" lay-filter="pm_select"
                                    style="width: 100px;">
                                <option value="">请选择机台编号</option>
                                <!-- {% if pm_list|length == 0 %}
                                        <option value="">请选择机台编号</option>
                                    {% endif %} -->
                                {% for item in pm_list %}
                                    <option value="{{ item['pm'] }}" {% if query_params['machine_pm'] == item['pm'] %}
                                            selected {% endif %}>
                                        {{ item['pm'] }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="layui-inline layui-show-xs-block">
                            <select name="machine_name" id="machine_name" class="layui-input" lay-filter="name_select"
                                    style="width: 120px;">
                                <option value="">请选择机台名称</option>
                                <!-- {% if pm_list|length == 0 %}
                                        <option value="">请选择机台名称</option>
                                    {% endif %} -->
                                {% for item in pm_list %}
                                    <option value="{{ item['name'] }}"
                                            {% if query_params['machine_name'] == item['name'] %} selected {% endif %}>
                                        {{ item['name'] }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="layui-inline layui-show-xs-block">
                            <button class="layui-btn" lay-submit="" lay-filter="sreach"><i
                                    class="layui-icon">&#xe615;</i></button>
                        </div>
                    </form>

                </div>
                <div class="layui-card-header">
                    {% if g.authority == '3' or g.authority == '2' %}
                        <button class="layui-btn layui-btn-danger" onclick="delAll()"><i class="layui-icon"></i>批量删除
                        </button>
                    {% endif %}
                    <button class="layui-btn"
                            onclick="xadmin.open('新增相机','/camera_add?machine_pm={{ query_params['machine_pm'] }}&machine_name={{ query_params['machine_name'] }}',600,490)">
                        <i class="layui-icon"></i>新增相机
                    </button>
                </div>
                <div class="layui-card-body layui-table-body layui-table-main">
                    <table class="layui-table layui-form">
                        <thead>
                        <tr>
                            <th style="width: 0px;">
                                <input type="checkbox" id="checkall" name="" lay-skin="primary">
                            </th>
                            <th>PM</th>
                            <th>机台名称</th>
                            <th>相机IP</th>
                            <th>相机端口</th>
                            <th>相机类型</th>
                            <th>相机位置</th>
                            <th>相机协议</th>
                            <th>连接状态</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for value in cameras %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="id" value="{{ value['CAMERA_ID'] }}"
                                           lay-skin="primary">
                                </td>
                                <td>
                                    <!-- 添加小圆点，控制颜色 -->
                                    <span class="circle-dot"
                                          style="background-color: {% if value['LINK_STATUS_COLOR'] == 'green' %}green{% elif value['LINK_STATUS_COLOR'] == 'gray' %}gray{% else %}red{% endif %};"></span>

                                    {% if value['MACHINE_PM'] is not none %}
                                        {{ value['MACHINE_PM'] }}
                                    {% else %}
                                        {{ '' }}
                                    {% endif %}
                                </td>
                                <td>{{ value['MACHINE_NAME'] }}</td>
                                <td>{{ value['CAMERA_IP'] }}</td>
                                <td>{{ value['CAMERA_PORT'] }}</td>
                                <td>{{ value['CAMERA_TYPE'] }}</td>
                                <td>{{ value['CAMERA_POSITION'] }}</td>
                                <td>{{ value['CAMERA_AGREEMENT'] }}</td>
                                <td>{{ value['LINK_STATUS'] }}</td>
                                <td class="td-manage">
                                    <a title="编辑"
                                       onclick="openEditModal(this,'{{ value['CAMERA_ID'] }}','{{ query_params['machine_name'] }}')"
                                       href="javascript:;">
                                        <i class="layui-icon">&#xe642;</i>
                                    </a>
                                    {% if g.authority == '3' or g.authority == '2' %}
                                        <a title="删除" onclick="camera_del(this,'{{ value['CAMERA_ID'] }}')"
                                           href="javascript:;">
                                            <i class="layui-icon">&#xe640;</i>
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>
<style>
    .circle-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }
</style>
</body>
<script>
    var server_url = "{{ server_url }}";
    var pmList = {{ pm_list | tojson }};  // 从后端传入的 PM 列表
    document.getElementById('checkall').addEventListener('change', function () {
        var checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
        for (var i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = this.checked;
        }
    });

    function delAll() {
        var ids = [];

        // 获取选中的id，避免重复遍历
        $('tbody input:checked').each(function () {
            ids.push($(this).val());
        });
        console.log(ids);
        if (ids.length === 0) {
            layer.msg('请至少选择一项', {icon: 2});
            return;
        }
        del_api(ids);
    }

    // 更新机台名称选择框
    // 监听机台编号下拉框的变化
    document.getElementById('machine_pm').addEventListener('change', function () {
        var selectedPm = this.value;
        var machineNameSelect = document.getElementById('machine_name');
        // 如果选中“请选择机台编号”，则回到默认状态
        if (selectedPm === '') {
            machineNameSelect.value = '';
        } else {
            pmList.forEach(function (item) {
                if (item.pm === selectedPm) {
                    machineNameSelect.value = item.name;
                }
            })
        }
    });

    // 监听机台名称下拉框的变化，更新机台编号
    document.getElementById('machine_name').addEventListener('change', function () {
        var selectedName = this.value;
        var machinePmSelect = document.getElementById('machine_pm');
        // 如果选中“请选择机台编号”，则回到默认状态
        if (selectedName === '') {
            machinePmSelect.value = '';
        } else {
            pmList.forEach(function (item) {
                if (item.name === selectedName) {
                    machinePmSelect.value = item.pm;
                }
            })
        }
    });

    /*参数-删除*/
    function camera_del(obj, ids) {
        // 提示确认删除操作
        layer.confirm('确认要删除吗？' + ids, {icon: 3}, function (index) {
            // 禁用按钮，避免重复点击
            $(obj).prop('disabled', true);

            // 发异步请求删除数据
            $.ajax({
                url: server_url + '/del_camera_info',  // 参数删除接口
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify([ids]),  // 传递要删除的对象标识符
                success: function (response) {
                    // 如果删除成功
                    if (response.message) {
                        // 删除行
                        $(obj).parents("tr").remove();
                        layer.msg(response.message, {icon: 1, time: 1000});
                    } else {
                        // 如果删除失败，提示错误信息
                        layer.msg(response.message, {icon: 2});
                    }
                },
                error: function (xhr, status, error) {
                    // 处理请求失败
                    layer.msg('删除失败，请稍后再试', {icon: 2});
                },
                complete: function () {
                    // 请求完成后重新启用按钮
                    $(obj).prop('disabled', false);
                }
            });

            // 关闭确认框
            layer.close(index);
        });
    }

    function del_api(ids) {
        // 提示机台确认删除
        layer.confirm('确认要删除吗？' + ids.join(', '), {icon: 3}, function (index) {
            // 禁用确认按钮，避免重复点击
            layer.close(index);
            layer.load(1);  // 显示加载层
            console.log(server_url + '/del_camera_info')
            // 发送删除请求
            $.ajax({
                url: server_url + '/del_camera_info', // 后端接口
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(ids), // 转换为 JSON 格式
                success: function (response) {
                    // 请求成功处理
                    if (response.message) {
                        layer.msg(response.message, {icon: 1});
                        // 删除选中的行
                        $("tbody input:checked").each(function () {
                            $(this).closest('tr').remove();
                        });
                    }
                },
                error: function (xhr, status, error) {
                    // 请求失败处理
                    var errorMessage = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : "删除失败";
                    layer.msg(errorMessage, {icon: 2});
                },
                complete: function () {
                    // 请求完成后，隐藏加载层
                    layer.closeAll('loading');
                }
            });
        });
    }


    function openEditModal(editButton, camera_id, machine_name) {
        // 获取当前行
        var row = editButton.closest('tr');

        // 获取当前行的各列数据
        var machine_pm = row.cells[1].innerText;
        var camera_ip = row.cells[3].innerText;
        var camera_port = row.cells[4].innerText;
        var camera_type = row.cells[5].innerText;
        var camera_position = row.cells[6].innerText;
        var camera_agreement = row.cells[7].innerText;


        // 创建查询字符串，传递需要的数据
        var url = '/camera_edit?machine_pm=' + encodeURIComponent(machine_pm) +
            '&camera_ip=' + encodeURIComponent(camera_ip) +
            '&camera_port=' + encodeURIComponent(camera_port) +
            '&camera_type=' + encodeURIComponent(camera_type) +
            '&camera_position=' + encodeURIComponent(camera_position) +
            '&camera_agreement=' + encodeURIComponent(camera_agreement) +
            '&camera_id=' + encodeURIComponent(camera_id) +
            '&machine_name=' + encodeURIComponent(machine_name);
        console.log(url)
        // 打开编辑页面并传递数据
        xadmin.open('编辑', url, 600, 500);
    }
</script>
</html>
